// NOMA Static Baseline - Streaming Evaluation
// Evaluates the trained model on the complete MNIST stream (clean + drift)
// Outputs metrics per sample for rolling accuracy computation

fn main() {
    print("=== NOMA Static Baseline - Streaming Evaluation ===");
    
    // =========================================================================
    // Load Trained Model Weights
    // =========================================================================
    print("Loading trained model weights...");
    // Paths are relative to the demo_TTA_MNIST folder (run_pipeline.sh cds there)
    load_safetensors_named W1 = "noma_baseline/output/model_weights.safetensors" : "W1";
    load_safetensors_named b1 = "noma_baseline/output/model_weights.safetensors" : "b1";
    load_safetensors_named W2 = "noma_baseline/output/model_weights.safetensors" : "W2";
    load_safetensors_named b2 = "noma_baseline/output/model_weights.safetensors" : "b2";
    print("Model loaded (784 -> 128 -> 10).");
    
    // =========================================================================
    // Load Streaming Data
    // =========================================================================
    print("Loading streaming data...");
    load_safetensors_named X_stream = "noma_baseline/data/mnist_stream_full.safetensors" : "x";
    load_safetensors_named Y_stream = "noma_baseline/data/mnist_stream_full.safetensors" : "y";
    load_safetensors_named T_stream = "noma_baseline/data/mnist_stream_full.safetensors" : "t";
    load_safetensors_named Phase_stream = "noma_baseline/data/mnist_stream_full.safetensors" : "phase";
    load_safetensors_named Intensity_stream = "noma_baseline/data/mnist_stream_full.safetensors" : "intensity";
    
    print("Stream loaded: 60000 samples");
    print("  t0 = 30000 (distribution shift point)");
    
    // =========================================================================
    // Full Evaluation (vectorized for efficiency)
    // =========================================================================
    print("Running evaluation on complete stream...");
    
    // Forward pass on entire dataset (2-layer network)
    let z1 = matmul(X_stream, W1) + b1;
    let h1 = relu(z1);
    let z2 = matmul(h1, W2) + b2;
    let pred_probs = softmax(z2);
    
    // Get predicted classes
    let pred_classes = argmax(pred_probs);
    
    print("Evaluation complete.");
    
    // =========================================================================
    // Save Results for Post-Processing
    // =========================================================================
    // Save prediction probabilities, true labels, and stream metadata
    // Post-processing in Python will argmax and compute rolling accuracy
    
    print("Saving results...");
    save_safetensors {
        pred_probs: pred_probs,
        y_true: Y_stream,
        t: T_stream,
        phase: Phase_stream,
        intensity: Intensity_stream
    }, "noma_baseline/output/eval_results.safetensors";
    
    print("Results saved to: noma_baseline/output/eval_results.safetensors");
    
    // =========================================================================
    // Quick Summary Statistics
    // =========================================================================
    
    print("Sample predictions (first 20):");
    print(pred_probs);
    print("True labels (first 20):");
    print(Y_stream);
    
    print("=== Evaluation Complete ===");
    print("Run Python post-processing to compute rolling accuracy and generate plots.");
    
    return 0.0;
}
